---
import { getCollection } from 'astro:content';
import BlogPostList from "@/layouts/BlogPostList.astro";
import { filterPosts } from "@/utils/misc";

// ✅ 添加 getStaticPaths
export async function getStaticPaths() {
  const posts = await getCollection('blog');
  const tagSet = new Set();
  posts.forEach(post => {
    (post.data.tags || []).forEach(tag => tagSet.add(tag));
  });
  return Array.from(tagSet).map(tag => ({
    params: { tag },
  }));
}

// 获取当前 tag
const { tag } = Astro.params;

// 获取全部文章
const posts = filterPosts(await getCollection('blog'), {
  filterDraft: true,
  filterUnlisted: true,
});

// 筛选包含当前标签的文章
const filteredPosts = posts.filter(
  post => post.data.tags && post.data.tags.includes(tag)
);

// 分页控制
const postsPerPage = 6;
const currentPage = Astro.url.searchParams.get('page')
  ? parseInt(Astro.url.searchParams.get('page'))
  : 1;

const totalPages = Math.ceil(filteredPosts.length / postsPerPage);
const startIndex = (currentPage - 1) * postsPerPage;
const endIndex = startIndex + postsPerPage;
const paginatedPosts = filteredPosts.slice(startIndex, endIndex);
---
<h1 class="text-2xl font-bold mb-4">标签：{tag}</h1>

{paginatedPosts.length > 0 ? (
  <BlogPostList
    data={paginatedPosts}
    currentPage={currentPage}
    lastPage={totalPages}
     currentPageTitle={tag}
  />
) : (
  <p>暂无包含此标签的文章。</p>
)}

{totalPages > 1 && (
  <div class="pagination-controls mt-8 flex justify-center items-center gap-4">
    {currentPage > 1 && (
      <a
        href={`/tags/${tag}?page=${currentPage - 1}`}
        class="px-4 py-2 border border-gray-300 rounded-md bg-white text-gray-700 hover:bg-gray-100 transition-colors duration-200"
      >
        上一页
      </a>
    )}
    <span class="font-semibold text-gray-800">
      第 {currentPage} 页 / 共 {totalPages} 页
    </span>
    {currentPage < totalPages && (
      <a
        href={`/tags/${tag}?page=${currentPage + 1}`}
        class="px-4 py-2 border border-gray-300 rounded-md bg-white text-gray-700 hover:bg-gray-100 transition-colors duration-200"
      >
        下一页
      </a>
    )}
  </div>
)}
