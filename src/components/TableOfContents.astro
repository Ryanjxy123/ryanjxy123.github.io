---
interface Props {
    headings: { depth: number; slug: string; text: string }[];
}

const { headings } = Astro.props;

const filteredHeadings = headings.filter(heading => heading.depth <= 3);
---

<nav class="toc-container relative pr-4 backdrop-blur-sm rounded-xl">
    <div class="absolute left-0 top-0 bottom-0 w-[2px] bg-[#e4e4e7] dark:bg-[#27272a]"></div>
    <div class="text-xs font-bold tracking-widest text-[#a1a1aa] uppercase mb-4 pl-4">TABLE OF CONTENTS</div>
    <ul class="relative">
        {
            filteredHeadings.map(heading => (
                <li>
                    <a
                        href={"#" + heading.slug}
                        class:list={[
                            "toc-link block py-2 transition-colors duration-200 border-l-2 border-transparent text-sm text-[#71717a] hover:text-[#2563eb]",
                            heading.depth === 3 ? "pl-8" : "pl-4",
                        ]}
                    >
                        {heading.text}
                    </a>
                </li>
            ))
        }
    </ul>
</nav>

<style>
    .active-toc-item {
        color: #2563eb !important;
        border-left-color: #2563eb !important;
    }
</style>

<script>
    const observer = new IntersectionObserver(
        entries => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    document.querySelectorAll(".toc-link").forEach(link => {
                        link.classList.remove("active-toc-item");
                    });
                    const id = entry.target.id;
                    const link = document.querySelector(`.toc-link[href="#${id}"]`);
                    if (link) {
                        link.classList.add("active-toc-item");
                    }
                }
            });
        },
        {
            rootMargin: "-100px 0px -66% 0px",
        },
    );

    document.querySelectorAll("h2, h3").forEach(heading => {
        observer.observe(heading);
    });

    // Handle TOC click events
    document.querySelectorAll(".toc-link").forEach(link => {
        link.addEventListener("click", e => {
            const href = link.getAttribute("href");
            if (!href || !href.startsWith("#")) return;

            const targetId = href.substring(1);
            const targetElement = document.getElementById(targetId);

            if (targetElement) {
                e.preventDefault();
                targetElement.scrollIntoView({ behavior: "smooth" });
                history.pushState(null, "", href);
            }
        });
    });
</script>
