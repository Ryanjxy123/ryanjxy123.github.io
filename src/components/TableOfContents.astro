---
interface Props {
    headings: { depth: number; slug: string; text: string }[];
}

const { headings } = Astro.props;

const filteredHeadings = headings.filter(heading => heading.depth <= 3);
---

<nav class="sticky top-32 w-full pr-4">
    <h3 class="mb-4 pl-2 text-sm font-bold tracking-widest text-[#52525b] uppercase">TABLE OF CONTENTS</h3>
    <ul class="relative border-l-2 border-[#e4e4e7] dark:border-[#27272a] ml-2">
        {
            filteredHeadings.map(heading => (
                <li>
                    <a
                        href={"#" + heading.slug}
                        class:list={[
                            "toc-link block py-2 pl-4 text-sm text-[#71717a] transition-colors border-l-2 border-transparent -ml-[2px] hover:text-[#2563eb]",
                            heading.depth === 3 ? "pl-8" : "pl-4",
                        ]}
                    >
                        {heading.text}
                    </a>
                </li>
            ))
        }
    </ul>
</nav>

<style>
    .active-toc-item {
        color: #2563eb !important;
        border-left-color: #2563eb !important;
    }
</style>

<script>
    const observer = new IntersectionObserver(
        entries => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    const id = entry.target.getAttribute("id");
                    const allLinks = document.querySelectorAll(".toc-link");
                    const activeLink = document.querySelector(`.toc-link[href="#${id}"]`);

                    if (activeLink) {
                        let foundActive = false;
                        // 遍历所有链接，实现“拖尾”效果
                        allLinks.forEach(link => {
                            if (link === activeLink) {
                                link.classList.add("active-toc-item");
                                foundActive = true; // 标记找到当前项，之后的都不激活
                            } else if (!foundActive) {
                                link.classList.add("active-toc-item"); // 当前项之前的，全部激活
                            } else {
                                link.classList.remove("active-toc-item"); // 当前项之后的，全部取消
                            }
                        });
                    }
                }
            });
        },
        {
            rootMargin: "-100px 0px -66% 0px",
        },
    );

    document.querySelectorAll("h2, h3").forEach(heading => {
        observer.observe(heading);
    });

    // Handle TOC click events
    document.querySelectorAll(".toc-link").forEach(link => {
        link.addEventListener("click", e => {
            const href = link.getAttribute("href");
            if (!href || !href.startsWith("#")) return;

            const targetId = href.substring(1);
            const targetElement = document.getElementById(targetId);

            if (targetElement) {
                e.preventDefault();
                targetElement.scrollIntoView({ behavior: "smooth" });
                history.pushState(null, "", href);
            }
        });
    });
</script>
