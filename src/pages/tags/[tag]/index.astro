---
import { getCollection } from "astro:content";
import BlogPostList from "@/layouts/BlogPostList.astro";
import { filterPosts } from "@/utils/misc";

// ✅ 添加 getStaticPaths
export async function getStaticPaths() {
    const posts = await getCollection("blog");
    const tagSet = new Set();
    posts.forEach(post => {
        (post.data.tags || []).forEach(tag => tagSet.add(tag));
    });
    return Array.from(tagSet).map(tag => ({
        params: { tag },
    }));
}

// 获取当前 tag
const { tag } = Astro.params;

// 获取全部文章
const posts = filterPosts(await getCollection("blog"), {
    filterDraft: true,
    filterUnlisted: true,
});

// 筛选包含当前标签的文章
const filteredPosts = posts.filter(post => post.data.tags && post.data.tags.includes(tag));

// 分页控制
const postsPerPage = 6;
const currentPage = Astro.url.searchParams.get("page") ? parseInt(Astro.url.searchParams.get("page")) : 1;

const totalPages = Math.ceil(filteredPosts.length / postsPerPage);
const startIndex = (currentPage - 1) * postsPerPage;
const endIndex = startIndex + postsPerPage;
const paginatedPosts = filteredPosts.slice(startIndex, endIndex);
---

{
    paginatedPosts.length > 0 ? (
        <BlogPostList data={paginatedPosts} currentPage={currentPage} lastPage={totalPages} currentPageTitle={tag} />
    ) : (
        <p>暂无包含此标签的文章。</p>
    )
}
