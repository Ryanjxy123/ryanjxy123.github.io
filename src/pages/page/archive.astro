---
import Layout from "../../layouts/BlogPage.astro";
import ArticleGridItem from "../../components/ArticleGridItem.astro";
import { filterPosts, type Post } from "../../utils/misc";
import { getCollection } from "astro:content";

// 归档页面处理流程
const posts = filterPosts(await getCollection("blog"), {
    filterDraft: true,
    filterUnlisted: true,
});
const yearMonthMap = new Map<string, Post[]>();
const yearList: { year: number; months: { month: number; posts: Post[] }[] }[] = [];
const amount = posts.length;

// 按时间降序排序
posts.sort((a, b) => {
    return b.data.pubDate.getTime() - a.data.pubDate.getTime();
});

// 按年月分组
posts.forEach((post) => {
    const year = post.data.pubDate.getFullYear();
    const month = post.data.pubDate.getMonth(); // 0-11

    const key = `${year}-${month}`;
    if (!yearMonthMap.has(key)) {
        yearMonthMap.set(key, []);
    }
    yearMonthMap.get(key)?.push(post);
});

// 转换为年月结构
yearMonthMap.forEach((posts, key) => {
    const [year, month] = key.split('-').map(Number);
    const yearEntry = yearList.find(y => y.year === year);

    if (yearEntry) {
        yearEntry.months.push({
            month,
            posts
        });
    } else {
        yearList.push({
            year,
            months: [{
                month,
                posts
            }]
        });
    }
});

// 对年份和月份进行排序
yearList.sort((a, b) => b.year - a.year);
yearList.forEach(year => {
    year.months.sort((a, b) => b.month - a.month);
});
---

<Layout
    title="归档"
    description=""
>
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
        <!-- 页面标题 -->
        <div class="mb-12 text-left">
            <h1 class="text-4xl md:text-5xl font-bold text-gray-900 dark:text-white mb-4">
                归档
            </h1>
            <p class="text-lg text-gray-600 dark:text-gray-400">
                如今，本博客已经有 {amount} 篇文章了呢。
            </p>
        </div>

        <!-- 时间轴网格 -->
        <div class="space-y-16">
            {yearList.map((yearData) => (
                <div key={yearData.year}>
                    <!-- 年份标题 -->
                    <h2 class="text-4xl font-bold text-gray-900 dark:text-white mb-8">
                        {yearData.year} 年
                    </h2>

                    <!-- 月份网格 -->
                    {yearData.months.map((monthData) => (
                        <div key={`${yearData.year}-${monthData.month}`} class="mb-12">
                            <!-- 月份标题 -->
                            <h3 class="text-xl text-gray-600 dark:text-gray-400 mb-6">
                                {monthData.month + 1} 月
                            </h3>

                            <!-- 文章卡片网格 -->
                            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                                {monthData.posts.map((post) => (
                                    <ArticleGridItem
                                        key={post.slug}
                                        title={post.data.title}
                                        url={`./post/${post.slug}/`}
                                        date={post.data.pubDate}
                                        tags={post.data.tags ?? []}
                                        heroImage={post.data.heroImage}
                                        body={post.body}
                                    />
                                ))}
                            </div>
                        </div>
                    ))}
                </div>
            ))}
        </div>
    </main>
</Layout>
